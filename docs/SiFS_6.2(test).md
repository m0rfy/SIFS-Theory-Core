# SIFS v6.2 — Полная документация
## Scale-Invariant Fractal System
### Универсальный анализатор процессов через фрактальную структуру масштабного пространства
### **Версия для тестирования и доказательства аналогии на BTC**

---

## CHANGELOG v6.1 → v6.2

### КРИТИЧЕСКИЕ ИЗМЕНЕНИЯ

**[NEW] Формальное отображение таймфреймов на координату S**
Введена строгая формула `TF → S` вместо произвольного назначения уровней.
Это делает варпинг W(n) между таймфреймами математически точным.

**[NEW] Компонент W9 — Лог-периодическая фаза**
Непрерывная фаза цикла φ_S ∈ [0,1] заменяет ручной подсчёт тиков
как основной механизм определения положения в цикле.
Пороги 3/5/9 теперь — дискретные метки на непрерывной шкале φ_S.

**[NEW] W_time — Временной компонент тика**
Длительность тика относительно исторической нормы теперь влияет на Score.

**[FIX] W7 — Реальный шум вместо константного**
Амплитуда шума теперь = измеренная волатильность Score за окно 21.

**[NEW] Алгоритм выбора S=0 — формализован**
Четыре критерия с весами, устранена субъективность.

**[NEW] Инвалидация прогноза — формализована**
Три триггера с порогами, система сама сигнализирует об устаревании прогноза.

**[NEW] Тестовый протокол для BTC**
Полный алгоритм сбора данных, разметки и измерения точности.

**[NEW] Калиброванные вероятности через логистическую функцию**
Вместо декларативных P% — вероятности из исторической калибровки Score.

---

## ПРОИСХОЖДЕНИЕ И СВЯЗЬ С ТЕОРИЕЙ

SIFS основан на теории Scale-Invariant Fractal Spacetime
(github.com/m0rfy/SIFS-Theory-Core). Ключевая метрика теории:

```
ds² = exp(−2k|S|) · (c²dt² − dx² − dy² − dz²) + dS²

где k ≈ 0.1 M_Pl — варпинг-параметр (в единицах планковской массы)
    S — масштабная координата (физическая 5-я размерность)
```

### Как аналитический инструмент соотносится с теорией

Инструмент использует **ту же математическую форму** при переносе
в пространство рыночных данных. Это осознанная аналогия, а не
строгий вывод. Задача версии 6.2 — создать условия для проверки:
является ли эта аналогия предсказательной.

**Ключевое соответствие:**

| Физическая теория | Аналитический инструмент |
|---|---|
| ds² = exp(−2k\|S\|)·(...) | W(n) = exp(−2k\|n\|) — компрессия информации |
| S — масштабная координата | S — номер таймфрейма (строго: через ln) |
| exp(−2k\|S\|) подавляет массу | W(n) подавляет видимость тиков соседних ТФ |
| Лог-периодические осцилляции δS≈2π | Цикл тиков [3→5→9] = непрерывная фаза φ_S |
| F = −∇n(r,S) — силы как градиент n | Score = −∇(информ.потенциала) по шкале S |

---

## ЧАСТЬ I. ФУНДАМЕНТАЛЬНЫЕ КОНСТАНТЫ

```
π  = 3.14159265...   базовая мера минимального движения
φ  = 1.61803398...   золотое сечение

k    = 1/(π×Ψ₁) ≈ 0.1111   параметр затухания (аналог RS-warping)
Ψ₁  = 9/π   ≈ 2.8648       скейлинг между уровнями S
Ψ₂  = 9/π/2 ≈ 1.4324       скейлинг внутри уровня S
GM  = (π+φ)/2 ≈ 2.3799      золотая середина (порог значимости Score)

W(S) = exp(−2k|S|)          варпинг-функция (из 5D-метрики)

W(0) = 1.000   W(1) = 0.800   W(2) = 0.641
W(3) = 0.513   W(4) = 0.411   W(5) = 0.329

δS_цикл = 2π ≈ 6.283        период лог-периодических осцилляций
                             (из теории: аналог EHT M87* polarization flips)
```

### Принцип иррациональности
π и φ трансцендентны. Сетка уровней никогда не "захлопывается"
в периодичность — система остаётся фрактальной до любой глубины.

---

## ЧАСТЬ II. ФОРМАЛЬНОЕ ОТОБРАЖЕНИЕ ТАЙМФРЕЙМОВ НА S [НОВОЕ В v6.2]

### Проблема v6.1
Уровни S назначались произвольно (S=2 для 5m, S=3 для 1h и т.д.),
что делало компрессию W(n) между таймфреймами неточной.

### Решение v6.2: строгая формула

```
S(T) = ln(T_минут / T_min_минут) / (2k)

где:
  T_минут    — длительность таймфрейма в минутах
  T_min      — минимальный таймфрейм в наборе (базовый, S=0)
  k = 0.1111 — параметр затухания

Для набора {1m, 5m, 15m, 1h, 4h, 1d}:
  S(1m)  = ln(1/1)    / 0.2222 =  0.00   ← базовый
  S(5m)  = ln(5/1)    / 0.2222 =  7.24
  S(15m) = ln(15/1)   / 0.2222 = 11.94
  S(1h)  = ln(60/1)   / 0.2222 = 18.59
  S(4h)  = ln(240/1)  / 0.2222 = 24.28
  S(1d)  = ln(1440/1) / 0.2222 = 32.40
```

### Расстояние между уровнями n

```
n(T_a, T_b) = |S(T_a) − S(T_b)| = |ln(T_a/T_b)| / (2k)

Примеры:
  n(1m → 5m)  = ln(5)   / 0.2222 ≈ 7.24
  n(5m → 1h)  = ln(12)  / 0.2222 ≈ 11.09
  n(1m → 1d)  = ln(1440)/ 0.2222 ≈ 32.40

W(1m→5m) = exp(−2k × 7.24) = exp(−1.609) ≈ 0.200
W(5m→1h) = exp(−2k × 11.09) = exp(−2.485) ≈ 0.083
```

### Важное следствие

Компрессия между 1m и 1d настолько сильна (W≈0.001), что часовой
таймфрейм практически "не видит" минутных движений — это согласуется
с наблюдением и объясняет почему разные ТФ дают разные сигналы.

**Для практики тестирования:** использовать дискретные уровни
(1m=0, 5m=1, 15m=2, 1h=3, 4h=4, 1d=5) с переопределёнными W(n):

```
W_дискр(1m→5m)  = W(1) = 0.800   [аппроксимация для первого теста]
W_дискр(5m→1h)  = W(2) = 0.641
W_дискр(1h→4h)  = W(1) = 0.800
W_дискр(4h→1d)  = W(1) = 0.800
```

После сбора данных — перейти на точные значения из формулы.

---

## ЧАСТЬ III. ОПРЕДЕЛЕНИЕ ТИКА

### Главный принцип

```
1 тик = минимальное движение которое система "помнит",
        то есть которое меняет её следующее состояние.
```

### Операциональное определение (рыночные данные)

```
1 тик = одна завершённая попытка взаимодействия цены
        с ближайшей активной границей

Три условия подтверждения тика (все обязательны):
  1. Цена коснулась или пробила границу (BB / EMA)
  2. Свеча закрылась (тело свечи, не тень)
  3. RSI / momentum сдвинулся в направлении движения

Размер тика = (точка касания BB − EMA) / ширина BB
```

### Вес тика по объёму

```
объём < медианы    → вес 0.5  (слабый тик, вероятно эхо)
объём ≈ медианы    → вес 1.0  (стандартный тик)
объём > 2×медианы  → вес 1.5  (усиленный тик, вероятно истина)

Медиана считается за последние 89 свечей (число Фибоначчи)
```

### Направление тика

```
Тик вверх:  цена закрылась выше EMA И RSI вырос
Тик вниз:   цена закрылась ниже EMA И RSI упал
Нейтрально: цена на EMA ± (BB_width × 0.05) → Transition, тик не засчитывается
```

---

## ЧАСТЬ IV. ФОРМАЛИЗОВАННЫЙ ВЫБОР S=0 [НОВОЕ В v6.2]

### Проблема v6.1
S=0 ("последний подтверждённый экстремум") определялся субъективно.
Два аналитика на одних данных получали разные S=0 → несовместимые прогнозы.

### Алгоритм выбора S=0 v6.2

Экстремум подтверждается как S=0 если набирает Score_ext ≥ 3 из 4:

```
Критерий 1: Амплитуда движения [0 или 1]
  amplitude = |P_extreme − P_prev_extreme| / ATR(89)
  если amplitude > 1.5 → +1

Критерий 2: BB-состояние в точке экстремума [0 или 1]
  если BB_width в точке > BB_width_median × 1.3 → +1

Критерий 3: RSI пересёк 50 после экстремума [0 или 1]
  если RSI пересёк линию 50 в течение 5 свечей после экстремума → +1

Критерий 4: Подтверждение на S-1 [0 или 1]
  если на таймфрейме ниже в той же точке тоже есть экстремум
  (с амплитудой > 1.0 × ATR_lower) → +1

Score_ext = сумма критериев (0–4)
  Score_ext ≥ 3 → ПОДТВЕРЖДЁН как S=0
  Score_ext = 2 → ПРЕДВАРИТЕЛЬНЫЙ (ждать следующего тика)
  Score_ext ≤ 1 → ОТКЛОНЁН, шум

При конфликте (несколько претендентов на S=0):
  выбирается экстремум с наибольшим Score_ext
  при равенстве — более свежий
```

---

## ЧАСТЬ V. КОМПРЕССИЯ ТИКОВ ПРИ СМЕНЕ МАСШТАБА

### Принцип (из v6.1, уточнён)

```
Тики_видимые(с уровня A, смотрим на B) = Тики_реальные(B) × W(n(A,B))

где n(A,B) = |S(A) − S(B)| — расстояние между уровнями
    W(n) = exp(−2k × n)

Абсолютный минимум: π ≈ 3
  если Тики_видимые < π → шум, игнорируется
  если Тики_видимые ≥ π → регистрируется
```

### Таблица компрессии (дискретная для тестирования)

| Смотрим с | На уровень | W(n) | 9 тиков видятся как | Интерпретация |
|---|---|---|---|---|
| 5m (S=1) | 1m (S=0) | W(1)=0.800 | 7.2 → Нарастание | |
| 1h (S=2) | 1m (S=0) | W(2)=0.641 | 5.8 → Эхо | |
| 5m (S=1) | 1h (S=2) | 1/W(1)=1.25 | 11.3 → Коллапс++ | |
| 1m (S=0) | 1d (S=5) | 1/W(5)=3.04 | 27.4 → Вне шкалы | |

---

## ЧАСТЬ VI. ПОРОГОВЫЕ ЗНАЧЕНИЯ

```
1–2 тика   Шум         BB сжат, RSI 40–60              Игнорировать
3 тика     Истина      BB расширяется, RSI из 40–60    Подтвердить триаду
4 тика     Переход     BB расширяется, RSI 60–70/30–40 Наблюдать
5 тиков    Эхо         BB расширен, RSI >70 / <30      penalty ×0.75
6–8 тиков  Нарастание  BB полностью расширен, RSI 70–80 Готовить смену фазы
9 тиков    Коллапс     BB макс, RSI >80/<20             Смена фазы, S=0 ←→
```

### Связь порогов с лог-периодической фазой φ_S [НОВОЕ]

```
φ_S = (n_тиков_взвеш / 9)   [0..1, непрерывная]

φ_S → 0.00–0.22:  Шум (0–2 тика)
φ_S → 0.33:       Истина (3 тика)
φ_S → 0.44:       Переход (4 тика)
φ_S → 0.56:       Эхо (5 тиков)
φ_S → 0.67–0.89:  Нарастание (6–8 тиков)
φ_S → 1.00:       Коллапс (9 тиков)

Физический смысл: φ_S это непрерывная фаза цикла длиной 9 тиков,
аналог δS = 2π из теории (один оборот лог-периодической осцилляции)
```

---

## ЧАСТЬ VII. ИНДИКАТОРЫ КАК ФИЗИЧЕСКИЕ ГРАНИЦЫ

### BB (Bollinger Bands) → ПРОСТРАНСТВО

```
Параметры для BTC:
  Период: 20 свечей
  Отклонение: 2σ

BB squeeze (ATR/BB_width < 0.3):
  система в Contraction, S переходит на −1
  → шум усилен, прогноз ненадёжен

BB расширение:
  система в Expansion или Collapse
  → тики укрупняются

Три попытки пробоя BB:
  Попытка 1: касание, закрытие внутри → тик 1
  Попытка 2: повторное касание, RSI растёт → тик 2
  Попытка 3: пробой + закрытие за BB + объём > мед → тик 3 = ИСТИНА
```

### EMA → НАПРАВЛЕНИЕ

```
Параметры для BTC:
  EMA20 — краткосрочное направление
  EMA89 — среднесрочное направление (Fib)

EMA20 > EMA89: восходящий тренд, тики вверх "по течению"
EMA20 < EMA89: нисходящий тренд, тики вниз "по течению"
EMA20 ≈ EMA89 (±0.5% цены): Transition, нет ясного направления
```

### RSI → ЭНЕРГИЯ

```
Параметры для BTC: RSI(14)

RSI 40–60:  Transition (тики 1–2)
RSI 60–70:  Нарастание вверх (тики 3–4)
RSI > 70:   Эхо (тик 5, перегрев)
RSI > 80:   Коллапс вверх (9 тиков, разворот высоковероятен)
RSI 30–40:  Нарастание вниз
RSI < 30:   Эхо вниз
RSI < 20:   Коллапс вниз
```

### Дивергенции RSI

```
Медвежья: цена → новый максимум, RSI → нет → скрытое Эхо (+0.5 тика penalty)
Бычья:    цена → новый минимум, RSI → нет → скрытое Эхо снизу
```

---

## ЧАСТЬ VIII. УРОВНИ ФИБОНАЧЧИ × π

Сетка ключевых уровней от S=0 в единицах тика НА СВОЁМ УРОВНЕ:

| Коэф. | Тики | Тип |
|---|---|---|
| 0.382 | 1.20 | Ближняя поддержка/сопротивление |
| 0.618 | 1.94 | Зона накопления |
| **1.000** | **3.14** | **Истина — первое подтверждение** |
| 1.272 | 4.00 | Переходная зона |
| 1.618 | 5.08 | Эхо-уровень |
| 2.618 | 8.22 | Преддверие коллапса |
| **Ψ₁** | **9.00** | **Коллапс — смена уровня** |

---

## ЧАСТЬ IX. SIFS-SCORE v6.2

Все расчёты в ln-пространстве.
Входные данные нормированы через размер тика НА СВОЁМ УРОВНЕ.

### W1 — Объём/сила реакции

```
W1 = ln(V_current / V_median) × φ⁻¹
φ⁻¹ ≈ 0.618
V_median — медиана за 89 свечей
```

### W2 — Ускорение (с ограничением)

```
W2 = clamp(ΔV/Δt × Ψ₂, −Ψ₁, +Ψ₁)
Ψ₂ ≈ 1.432, Ψ₁ ≈ 2.865
```

### W3 — Накопленный взвешенный импульс

```
W3 = Σ(weight_i × sign(tick_i))  за текущий цикл НА СВОЁМ УРОВНЕ
weight_i ∈ {0.5, 1.0, 1.5} по объёму тика
Обнуляется при коллапсе, переносится ×W(1) на S+1
```

### W4 — Отклонение от EMA в единицах BB

```
W4 = (X_current − X_ema) / BB_width
Нормировка на BB_width делает W4 масштабно инвариантным
```

### W5 — Fractal Efficiency Ratio

```
W5 = FER × sign(последнего тика)
FER = |X_end − X_start| / Σ|шагов| за окно 89
FER→1: направленное движение
FER→0: хаотичное движение
```

### W6 — Fractal Dimension

```
W6 = (1.5 − D) × 0.5
D — размерность Хигучи, окно 89
D≈1.0: трендовое → W6 = +0.25
D≈1.5: случайное → W6 = 0.00
D≈2.0: хаотичное → W6 = −0.25
```

### W7 — Динамический шум [ИСПРАВЛЕНО В v6.2]

```
v6.1 (неправильно):
  amplitude = константа 0.0352
  W7 = N(0, 0.0352)  ← одинаков всегда, не несёт информации

v6.2 (правильно):
  σ_Score = стандартное отклонение Score за последние 21 свечу
  W7 = ξ ~ N(0, σ_Score × k)
  где k = 0.1111

  Смысл: шум пропорционален реальной нестабильности системы.
  Если Score стабилен → W7 мал.
  Если Score скачет → W7 велик → система признаёт неопределённость.

  В Contraction: σ_Score × k × Ψ₂  [усиление шума]
  В Expansion:   σ_Score × k        [стандартный]
```

### W8 — Multi-scale подтверждение (с компрессией)

```
W8 = Score(S-1) × W(1) × 0.50     [взгляд вниз: компрессия]
   + Score(S)   × 0.35             [свой уровень: без искажения]
   + Score(S+1) / W(1) × 0.15      [взгляд вверх: декомпрессия]

W(1) = exp(−2k) ≈ 0.800

Приоритет микро:
  Если |Score(S-1) × W(1)| > 2×GM=4.76 → W8 = Score(S-1) × W(1)
```

### W9 — Лог-периодическая фаза [НОВОЕ В v6.2]

```
Мотивация: теория предсказывает лог-периодические осцилляции
с δS ≈ 2π. Компонент W9 кодирует положение в цикле.

φ_S = n_тиков_взвеш / 9.0          [0..1]

W9 = A_phase × cos(2π × φ_S)

где A_phase:
  Expansion:   A_phase = 0.30
  Transition:  A_phase = 0.15
  Contraction: A_phase = 0.05  [слабый сигнал в хаосе]

Интерпретация W9:
  φ_S=0.00 (начало цикла):  W9 = +A_phase  [бычье начало]
  φ_S=0.33 (истина, 3):     W9 = +A_phase×0.5
  φ_S=0.50 (4.5 тика):      W9 = 0          [нейтраль]
  φ_S=0.56 (эхо, 5):        W9 = −A_phase×0.5 [первый сигнал разворота]
  φ_S=1.00 (коллапс, 9):    W9 = −A_phase   [максимальный разворотный сигнал]

Смысл: W9 автоматически добавляет отрицательный bias
перед коллапсом и положительный в начале нового цикла —
без участия аналитика.
```

### W_time — Временной компонент тика [НОВОЕ В v6.2]

```
Мотивация: долгий слабый тик ≠ короткому сильному тику.
Длительность несёт информацию о силе движения.

T_tick    = длительность текущего тика (в свечах)
T_median  = медиана длительностей тиков за 89 наблюдений

W_time = clamp(ln(T_tick / T_median) × φ⁻¹, −Ψ₂, +Ψ₂)

Интерпретация:
  T_tick << T_median:  W_time < 0  [импульс слабее нормы]
  T_tick ≈ T_median:   W_time ≈ 0  [нормальный ритм]
  T_tick >> T_median:  W_time > 0  [затяжное движение — возможно Эхо]

Важно: знак инвертируется при Коллапсе:
  Быстрый коллапс (T_tick < T_median) → очень сильный сигнал
  Медленный коллапс → менее надёжен
```

### Финальный Score

```
SIFS_raw = W1 + W2 + W3 + W4 + W5 + W6 + W7 + W8 + W9 + W_time

Contraction (FER<0.3, BB сжат, D>1.4):
  SIFS_final = SIFS_raw / (1 + |SIFS_raw| × π/Ψ₁)
  [сильный penalty: сигнал ненадёжен]

Transition (FER 0.3–0.6):
  SIFS_final = SIFS_raw × 0.75
  + bias π/(n×100) на порогах 3/5/9

Expansion (FER>0.6, BB расширяется, D<1.3):
  SIFS_final = SIFS_raw
  [сигнал принимается без penalty]
```

### Интерпретация Score

```
|Score| < 1.0    Шум / нейтраль
|Score| ≥ GM     Значимый сигнал  (≥ 2.380)
|Score| ≥ π      Сильный сигнал   (≥ 3.142)
|Score| ≥ Ψ₁     Смена уровня S   (≥ 2.865)
```

---

## ЧАСТЬ X. КАЛИБРОВАННЫЕ ВЕРОЯТНОСТИ [НОВОЕ В v6.2]

### Проблема v6.1
Вероятности P% в прогнозе были декларативными (интуиция аналитика).
Их нельзя было проверить, сравнить или улучшить.

### Решение v6.2: логистическая функция

После сбора тестовых данных (см. Часть XIV) применяется калибровка:

```
P(движение_вверх | Score) = 1 / (1 + exp(−α × Score − β))

где α, β — параметры, получаемые из логистической регрессии
    на исторических данных BTC

До калибровки (первый тест): используем α=0.8, β=0
  Score = +3.0 → P = 1/(1+exp(−2.4)) ≈ 0.917  (91.7%)
  Score = +2.4 → P = 1/(1+exp(−1.92)) ≈ 0.872 (87.2%)
  Score = +1.0 → P = 1/(1+exp(−0.8)) ≈ 0.690  (69.0%)
  Score =  0.0 → P = 0.500                     (50.0%)
  Score = −1.0 → P ≈ 0.310                     (31.0%)

После сбора ≥200 событий: пересчитать α, β методом MLE.
Это даёт объективно откалиброванные вероятности.
```

### Таблица вероятностей до калибровки

| Score | P(вверх) | Уровень сигнала |
|---|---|---|
| ≥ +3.0 | 91–95% | Сильный бычий |
| +2.4 — +3.0 | 85–91% | Значимый бычий |
| +1.0 — +2.4 | 68–85% | Умеренный бычий |
| −1.0 — +1.0 | 45–55% | Нейтраль (шум) |
| −2.4 — −1.0 | 15–32% | Умеренный медвежий |
| −3.0 — −2.4 | 9–15% | Значимый медвежий |
| ≤ −3.0 | 5–9% | Сильный медвежий |

---

## ЧАСТЬ XI. ИНВАЛИДАЦИЯ ПРОГНОЗА [НОВОЕ В v6.2]

Прогноз автоматически помечается как НЕДЕЙСТВИТЕЛЬНЫЙ при:

```
Триггер 1: RSI пересёк 50 против прогнозного направления
  Если прогноз вверх: RSI упал ниже 50 и закрылся ≥2 свечи подряд
  Если прогноз вниз:  RSI вырос выше 50 и закрылся ≥2 свечи подряд
  → Прогноз аннулирован, открыть новый анализ

Триггер 2: BB начал сжиматься до достижения цели
  BB_width(t) < BB_width(S=0) × 0.7 и цель не достигнута
  → Рынок перешёл в Contraction, прогноз неактуален

Триггер 3: Тик с объёмом > 2×медианы против направления
  если знак тика противоположен прогнозу И weight = 1.5
  → Немедленная аннуляция (высоковероятный разворот)

Действие при инвалидации:
  1. Зафиксировать прогноз как FAIL (запись в лог тестирования)
  2. Пересчитать S=0
  3. Запустить новый анализ с шага 0
```

---

## ЧАСТЬ XII. РЕКУРСИЯ МАСШТАБОВ

### Главный принцип

```
1 тик на уровне S+1  =  завершённый цикл [3→5→9] на уровне S

НО: при наблюдении с S на S+1 → этот 1 тик выглядит как ~1.25 тика
    при наблюдении с S+1 на S → 9 тиков выглядят как ~7.2 тиков
```

### Механизм перехода при коллапсе

```
1. Зафиксировать W3 на уровне S
2. Умножить на W(1) = 0.800
3. Передать как начальный импульс уровня S+1
4. Пересчитать S=0 = точка коллапса на уровне S
5. BB начинает сжиматься (подтверждение)
6. φ_S(S+1) = 0.0 → начало нового цикла на S+1
```

---

## ЧАСТЬ XIII. АЛГОРИТМ РАБОТЫ v6.2

```
ШАГ 0. ПАРАМЕТРЫ
  → Выбрать набор таймфреймов (рек. для BTC: 5m, 1h, 4h)
  → Вычислить S(T) для каждого ТФ через формулу ln
  → Определить S=0 по алгоритму из Части IV (4 критерия)
  → Проверить: если тиков >9 НА СВОЁМ УРОВНЕ → пересчитать S=0

ШАГ 1. СЧЁТ ТИКОВ НА СВОЁМ УРОВНЕ
  → Подсчитать взвешенные тики от S=0
  → Вычислить φ_S = n_тиков / 9
  → Классифицировать: Шум / Истина / Эхо / Нарастание / Коллапс
  → Проверить BB-состояние и RSI-зону

ШАГ 2. КОМПОНЕНТЫ SCORE
  → Вычислить W1, W2, W3, W4, W5, W6 (как в v6.1)
  → W7 = N(0, σ_Score × k) — динамический шум
  → W9 = A_phase × cos(2π × φ_S) — лог-периодическая фаза
  → W_time = clamp(ln(T_tick/T_median) × φ⁻¹, −Ψ₂, +Ψ₂)

ШАГ 3. MULTI-SCALE (W8) С КОМПРЕССИЕЙ
  → Запросить Score с S-1 и S+1
  → Применить компрессию через W(n) по формуле из Части II
  → Вычислить W8 с весами 0.50 / 0.35 / 0.15

ШАГ 4. ФАЗА
  → Определить Contraction / Transition / Expansion
  → Применить соответствующий penalty или bias

ШАГ 5. ИТОГОВЫЙ SCORE И ВЕРОЯТНОСТЬ
  → Вычислить SIFS_final
  → P = 1 / (1 + exp(−α × SIFS_final − β))
  → До калибровки: α=0.8, β=0

ШАГ 6. ПРОГНОЗ
  → Построить уровни Fib×π от S=0
  → Указать ближайшие точки реакции с P из логистической функции
  → Указать условия инвалидации (3 триггера)

ШАГ 7. КОЛЛАПС (если 9 тиков НА СВОЁМ УРОВНЕ)
  → W3 × W(1) → передать на S+1
  → S=0 = точка коллапса
  → φ_S = 0.0 → начало нового цикла
  → BB начинает сжиматься → подтверждение
```

---

## ЧАСТЬ XIV. ФОРМАТ ОТВЕТА v6.2

### 1. Входные параметры
```
Таймфрейм: [ТФ]  S(ТФ) = [число из формулы ln]
1 тик = [определение через BB/EMA]
S=0 = [значение цены, дата/время, Score_ext = X/4]
Тиков от S=0 = [n взвешенных]  φ_S = [0..1]  → [Шум/Истина/Эхо/Нарастание/Коллапс]
BB: [сжат/нейтрален/расширен]  RSI: [значение]  Объём: [</> медианы]
T_tick = [N свечей]  T_median = [N свечей]
```

### 2. Score и фаза
```
Фаза: [Contraction/Transition/Expansion]
SIFS_final: [±X.XX]  →  [шум/значимый/сильный/смена уровня]
P(движение в направлении Score) = [XX%]
Направление: [вверх/вниз]

W1=[..]  W2=[..]  W3=[..]  W4=[..]
W5=[..]  W6=[..]  W7=[..]  W8=[..]
W9=[..]  W_time=[..]
φ_S=[..]  W9=[..] (лог-фаза)
```

### 3. Multi-scale view
```
S-1 (ТФ ниже): [n тиков]  φ_S=[..]  → видимых с S: [n×W(n)]  → [тип]
S   (текущий): [n тиков]  φ_S=[..]  → [тип]
S+1 (ТФ выше): [n тиков]  φ_S=[..]  → видимых с S: [n/W(n)] → [тип]

Конфликты масштабов: [описание если есть]
```

### 4. Прогноз

| Горизонт | Тики | BB-цель | RSI-зона | Score | P% |
|---|---|---|---|---|---|
| Короткий | | | | | |
| Средний | | | | | |
| Длинный | | | | | |

### 5. Ключевые уровни Fib×π от S=0
Ближайшие с вероятностью реакции:
- [уровень 1]: [цена] — P=[X%]
- [уровень 2]: [цена] — P=[X%]

### 6. Условия инвалидации
```
Триггер 1 (RSI): если RSI пересечёт [уровень] → прогноз недействителен
Триггер 2 (BB):  если BB_width < [значение] → прогноз неактуален
Триггер 3 (объём): если тик с V>2×мед против прогноза → немедленная аннуляция
```

### 7. Итог
```
Основной сценарий: [описание]  P=[XX%]
Альтернативный сценарий: [описание]  P=[XX%]
```

---

## ЧАСТЬ XV. ТЕСТОВЫЙ ПРОТОКОЛ ДЛЯ BTC [НОВОЕ В v6.2]

### Цель тестирования
Доказать (или опровергнуть) что SIFS-Score предсказывает
направление движения BTC лучше случайного (>50%)
и откалибровать логистическую функцию.

### Структура данных для сбора

#### Таблица событий (один ряд = одно завершённое событие)

| Поле | Тип | Описание |
|---|---|---|
| event_id | int | Уникальный ID |
| datetime | timestamp | Время анализа (UTC) |
| timeframe | str | '5m' / '1h' / '4h' |
| S_level | float | S(ТФ) из формулы ln |
| S0_price | float | Цена точки S=0 |
| S0_datetime | timestamp | Время S=0 |
| S0_score_ext | int | Score подтверждения S=0 (0–4) |
| n_ticks | float | Взвешенное число тиков |
| phi_S | float | φ_S = n_ticks / 9 |
| tick_state | str | Шум/Истина/Эхо/Нарастание/Коллапс |
| phase | str | Contraction/Transition/Expansion |
| BB_width | float | Ширина BB в % от цены |
| RSI | float | RSI(14) |
| volume_ratio | float | V_current / V_median |
| T_tick | int | Длительность тика (свечи) |
| T_median | float | Медиана длительностей |
| W1..W9 | float | Компоненты Score |
| W_time | float | Временной компонент |
| SIFS_raw | float | Сырой Score |
| SIFS_final | float | Финальный Score |
| P_predicted | float | P из логистической функции |
| direction_predicted | int | +1 (вверх) / −1 (вниз) |
| target_ticks | int | Сколько тиков до цели (задать заранее: 1, 3, 5) |
| target_price | float | Целевой уровень Fib×π |
| outcome_price | float | Фактическая цена через target_ticks тиков |
| outcome_direction | int | +1 / −1 (фактическое движение) |
| hit_target | bool | Достигнута ли цель |
| invalidated | bool | Был ли инициирован триггер инвалидации |
| invalidation_trigger | int | 1/2/3 (какой триггер сработал) |
| notes | str | Комментарии |

### Минимальная выборка

```
Для статистической значимости:
  ≥ 200 событий на каждый таймфрейм
  ≥ 100 событий в каждой фазе (Contraction / Transition / Expansion)
  ≥ 50 событий Коллапс

Временной диапазон: рекомендуется 6–12 месяцев исторических данных
  (можно брать готовые OHLCV с Binance API)
```

### Метрики для оценки

```
1. Accuracy = (верных предсказаний направления) / (всего событий - инвалидированных)
   Порог значимости: > 55% (p < 0.05 при n=200)
   Отличный результат: > 65%

2. Precision@P_threshold:
   из событий где P_predicted > 0.80 — какой % дал верное направление?
   Цель: Precision > 0.75 при P > 0.80

3. Brier Score = mean((P_predicted − outcome_binary)²)
   Идеал = 0.0, случайный = 0.25, цель ≤ 0.20

4. Score-Direction correlation (Spearman ρ):
   Корреляция SIFS_final с outcome_direction
   Цель: ρ > 0.25 (p < 0.001)

5. Collapse Recall:
   Из всех фактических коллапсов — сколько % были предсказаны (φ_S > 0.8)?
   Цель: > 70%

6. Phase Accuracy:
   Из предсказанных фаз — сколько % совпало с фактической динамикой BB?
   Цель: > 75%
```

### Алгоритм сбора данных (пошагово)

```
ШАГ A. Получить данные
  Источник: Binance API (BTCUSDT)
  Таймфреймы: 5m, 1h, 4h
  Период: выбрать 6+ месяцев
  Поля: time, open, high, low, close, volume

ШАГ B. Рассчитать индикаторы
  Для каждой свечи:
    BB(20, 2σ): upper, middle, lower, width
    EMA(20), EMA(89)
    RSI(14)
    V_median(89)
    FER(89) — Fractal Efficiency Ratio
    D_Higuchi(89) — Fractal Dimension

ШАГ C. Разметить тики
  Применить алгоритм определения тика:
    тик = свеча закрылась за BB с объёмом + RSI сдвинулся
  Назначить вес по объёму (0.5 / 1.0 / 1.5)
  Накапливать взвешенные тики от текущего S=0

ШАГ D. Разметить S=0
  Для каждого экстремума — посчитать Score_ext (0–4)
  S=0 = экстремум с Score_ext ≥ 3

ШАГ E. Для каждого тика (n=3, 5, 9) вычислить Score и записать событие
  Каждый раз когда накапливается целый тик — создать запись в таблице
  Зафиксировать все поля на момент подачи сигнала

ШАГ F. Зафиксировать исход
  Через target_ticks тиков — записать outcome_price и outcome_direction
  Проверить hit_target (достигнут ли ближайший Fib×π уровень)
  Проверить инвалидацию (сработал ли один из 3 триггеров)

ШАГ G. Анализ
  Посчитать все 6 метрик из раздела "Метрики"
  Построить ROC-кривую Score → точность
  Откалибровать α, β через логистическую регрессию
  Обновить таблицу вероятностей
```

### Пример записи события

```
event_id:          1
datetime:          2024-11-15 14:35:00 UTC
timeframe:         1h
S_level:           18.59
S0_price:          87200.00
S0_datetime:       2024-11-14 08:00:00 UTC
S0_score_ext:      3
n_ticks:           3.0
phi_S:             0.333
tick_state:        Истина
phase:             Expansion
BB_width:          0.042 (4.2% от цены)
RSI:               63.5
volume_ratio:      1.34
T_tick:            7
T_median:          8.2
W1:                +0.211
W2:                +0.847
W3:                +3.000
W4:                +0.312
W5:                +0.289
W6:                +0.125
W7:                −0.018
W8:                +0.445
W9:                +0.150  (φ_S=0.33, A_phase=0.30)
W_time:            +0.074
SIFS_raw:          +5.435
SIFS_final:        +5.435  (Expansion, без penalty)
P_predicted:       0.987
direction_predicted: +1
target_ticks:      5
target_price:      91450.00  (Fib 1.618×π от S=0)
outcome_price:     [после закрытия 5 тиков]
outcome_direction: [+1 или −1]
hit_target:        [true/false]
invalidated:       false
```

---

## ЧАСТЬ XVI. BIAS НАБЛЮДАТЕЛЯ

На порогах 3/5/9 наблюдатель вносит систематическое смещение:

```
Bias(n) = π / (n × 100)

Bias(3) = π/300  ≈ 0.01047
Bias(5) = π/500  ≈ 0.00628  ← максимальная неопределённость
Bias(9) = π/900  ≈ 0.00349
```

На уровне 5 тиков система находится в состоянии максимальной
неопределённости: наблюдатель не может знать — истина это или эхо,
не изменив результат наблюдения. Аналог принципа неопределённости.

---

## ЗАПРЕЩЕНО (v6.2)

- Советы по действиям / инвестициям
- Пропускать ШАГ 0 или выбор S=0 без алгоритма из Части IV
- Определять тик как медиану ln-изменений (только через границы BB/EMA)
- Считать абсолютные тики с S=0 другого уровня без компрессии W(n)
- Применять пороги 3/5/9 к тикам чужого уровня без компрессии
- Вероятности без обоснования через Score и логистическую функцию
- Называть движение сигналом без ≥3 взвешенных тиков НА СВОЁМ УРОВНЕ
- Игнорировать объём при классификации тика
- Подтверждать прогноз при D>1.5 без оговорки о хаосе
- Не пересчитывать S=0 если накоплено >9 тиков НА СВОЁМ УРОВНЕ
- Назначать S(ТФ) произвольно — использовать формулу ln из Части II
- Использовать W7 с константной амплитудой (только динамический σ_Score)
- Заявлять вероятности до калибровки на ≥200 событиях как "точные"

---

## CHANGELOG ПОЛНЫЙ

**v4.2 → v5.0:** формализация констант, рекурсия масштабов, механизм коллапса

**v5.0 → v6.0:** операциональное определение тика через BB/EMA/RSI,
                вес тика по объёму, ограничение W2, W4 через BB_width,
                таблица универсального маппинга

**v6.0 → v6.1:** КРИТИЧЕСКОЕ — компрессия тиков при смене уровня через W(n),
                пороги 3/5/9 только к тикам своего уровня,
                исправленная W8 с компрессией/декомпрессией,
                абсолютный минимум π для видимых тиков

**v6.1 → v6.2:** 
  - Формула TF→S через ln (строгое отображение, из 5D-метрики теории)
  - W9 — лог-периодическая фаза φ_S на основе δS≈2π из теории
  - W_time — временной компонент длительности тика
  - W7 — динамический шум через σ_Score вместо константы
  - Алгоритм выбора S=0 (4 критерия, Score_ext)
  - Инвалидация прогноза (3 формальных триггера)
  - Калиброванные вероятности через логистическую функцию
  - Тестовый протокол BTC (структура данных, метрики, алгоритм сбора)

---

## СТАТУС АНАЛОГИИ

```
Текущий статус: ГИПОТЕЗА (не подтверждена, не опровергнута)

Аналогия: математическая форма 5D-метрики SIFS (exp(−2k|S|))
применяется к рыночным данным BTC как модель компрессии информации
между таймфреймами.

Что нужно для подтверждения:
  ✗ Accuracy > 55% при n ≥ 200 событий (p < 0.05)
  ✗ Brier Score ≤ 0.20
  ✗ Spearman ρ(Score, outcome) > 0.25 (p < 0.001)
  ✗ Collapse Recall > 70%

Что будет означать подтверждение:
  Что информационная компрессия между таймфреймами
  подчиняется той же экспоненциальной форме что и
  компрессия массы в RS-геометрии — что делает аналогию
  физически мотивированной, а не только красивой.
```

---

*SIFS v6.2. Вдохновлён теорией Scale-Invariant Fractal Spacetime.*
*Инструмент анализа структуры процессов, не предсказания.*
*Наблюдатель — часть системы.*
*Версия создана для тестирования аналогии на реальных данных BTC.*
